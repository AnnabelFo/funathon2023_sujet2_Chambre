---
title: "Évolution de la date théorique de récolte"
pagetitle: "ERA5"
subtitle: "Agronomie et données climatiques rétrospectives avec ERA5"
author: "Michaël Delorme"
author-meta: "`r Sys.info()['user']`"
date: "`r Sys.Date()`"
date-meta: "`r Sys.time()`"
abstract-title: Résumé
keywords: ["productions végétales", "agronomie", "climat", "ERA5", "France"]
lang: fr
language: 
  title-block-author-single: ""
  title-block-affiliation-single: ""
  title-block-published: ""
format: 
  html:
    anchor-sections: true
    smooth-scroll: true
    self-contained: true
    toc: true
    toc-depth: 3
    theme: united
    code-fold: true
    code-tools: true
    code-summary: "voir le code"
    toc-title: "Sommaire"
number-sections: true
mainfont: "Marianne"
monofont: "Fira Code"
code-fold: true
crossref:
  fig-prefix: figure
  fig-title:  Figure
  tbl-prefix: tableau
  tbl-title:  Tableau
  title-delim: " &ndash; "
  sec-prefix: chapitre
editor_options: 
  chunk_output_type: console
execute: 
  eval: true
  echo: true
  message: false
  warning: false
  error: false
knitr:
  opts_chunk: 
    dev: "ragg_png"
    out.width: 100%
---

Les organismes, dont les plantes, ont besoin d'une certaine quantité de chaleur pour se développer. La notion de *degrés jours* a été introduite par les biologistes pour quantifier ce besoin physiologique. Il s'exprime par la somme des différences entre la température moyenne journalière et une température de base[^1].

[^1]: [Degré jour de croissance. *Wikipedia*](https://fr.wikipedia.org/wiki/Degr%C3%A9_jour_de_croissance)

$$DJ_{n} = \sum_{j=1}^{n}{\frac{T_{max, j} - T_{min, j}}{2} - T_{base}}$$

Le maïs a une température de base de 6 °C et il lui faut 1500 DJ (variable selon la précocité de la variété) pour être récolté pour l'ensilage[^2] destiné à nourrir le bétail, ou 1700 DJ pour le maïs grain. Les températures supérieures à 30 °C stoppent le développement végétatif. Le semis se fait début avril[^3].

[^2]: [*Spotifarm*](https://blog.spotifarm.fr/tour-de-plaine-spotifarm/somme-de-temperature-pourquoi-suivre-levolution-des-degres-jours)

[^3]: [Céré'Obs. *FranceAgrimer*](https://cereobs.franceagrimer.fr/cereobs-sp/assets/pdfjs/web/viewer.html?file=blob:https://cereobs.franceagrimer.fr/f05c19c6-aff4-4701-9af4-80fdef7118d3)

**Peut-on voir comment a évolué la date de récolte théorique d'une parcelle de maïs au cours des dernières années ?**

# Données

-   Le [RPG](https://geoservices.ign.fr/rpg) recense les parcelles déclarées à la PAC par les agricuteurs : données graphiques et leur culture principale, pour récupérer les cordonnées géographiques d'une parcelle de maïs.  
Les données sont disponibles dans une base PostGIS.

-   [ERA5 agrometeorological indicators](https://cds.climate.copernicus.eu/cdsapp#!/dataset/sis-agrometeorological-indicators) est un jeu de données issu d'un projet de réanalyse météorologique qui vise à uniformiser et corriger les données historiques (ERA5).
Il fournit des paramètres agro-météorologiques de surface quotidiens pour la période allant de 1979 à aujourd'hui à une résolution spatiale de 0,1 ° (soit environ 8×11 km en France).  
Les données de température moyenne 1979-2022 (87 Go à l'origine) ont été préchargées sur Minio et limitées à l'emprise de la métropole, représentant au final 16 000 fichiers de 76 ko = 1.1 Go).
Elles sont au format [NetCDF](https://fr.wikipedia.org/wiki/NetCDF). Un package R existe pour importer et requêter ce jeu de données particulier : [{ag5Tools}](https://github.com/AgrDataSci/ag5Tools).
Les données peuvent aussi être traitées avec les packages de manipulation de rasters tels que [{terra}](https://rspatial.org/spatial/index.html) (ou {raster}) et [{stars}](https://r-spatial.github.io/stars/.

# Préparation

Il faut avoir préalablement copié les données depuis le stockage S3 Minio :

`$ mc cp -r s3/projet-funathon/2023/sujet2/era5/ funathon2023_sujet2/donnees/era5/`

```{r}
#| label: setup
library(stars)
library(tidyverse)
library(glue)
library(fs)
library(knitr)
library(gtsummary)

# localisation des données dans le stockage "local"
rep_era5 <- "../donnees/era5"

invisible(Sys.setlocale("LC_ALL", "fr_FR.UTF-8"))
```


# Extraction

Exemple avec une couche contenant 2 points.

```{r}
#| label: donnees
#| cache: true
#| results: hide
# un exemple de localisations
points <- tribble(~ville,       ~lon,   ~lat,
                  "Talissieu", 5.725, 45.864,
                  "Toulouse",  1.434, 43.591) %>% 
  st_as_sf(coords = c("lon", "lat"), crs = "EPSG:4326")

era5 <- dir_ls(rep_era5, recurse = TRUE, glob = "*.nc") %>% 
  read_stars() %>% 
  rename(temp_moy_k = 1)

temp_points <- era5 %>% 
  st_extract(points) %>%
  as_tibble() %>% 
  mutate(temp_moy_c = temp_moy_k - 273.15,
         date = as_date(time)) %>% 
  full_join(points, ., by = "geometry")
```


# Calcul des degrés jour et des dates de récolte

```{r}
#| label: traitement

# la date n'est pas un bon indicateur pour suivre précisémment une évolution 
# journalière à cause des années bissextiles 
#   -> on utilisaera le day of year (doy)
# yday(ymd("2020-04-01"))
# yday(ymd("2023-04-01"))

# base de calcul pour maïs : 6 °C
base <- 6 # °C

# besoin total à récolte pour un maïs grain de précocité moyenne : 1700 DJ
besoin <- 1700 # DJ

recolte <- temp_points %>% 
  select(date, ville, temp_moy_c) %>% 
  group_by(ville, annee = year(date)) %>% 
  mutate(dj = case_when(yday(date) < 91 ~ 0,
                        temp_moy_c > 30 ~ 0,
                        temp_moy_c < base ~ 0,
                        TRUE ~ temp_moy_c - base),
         sdj = cumsum(dj)) %>%
  filter(sdj > besoin) %>% 
  slice_min(date) %>% 
  ungroup() %>% 
  select(date, annee, ville)
```

```{r}
#| label: tbl-resultats
#| echo: false
#| tbl-cap: Dates de récolte potentielles
options(knitr.kable.NA = '')
recolte %>% 
  arrange(ville, annee) %>% 
  group_by(ville) %>%
  slice_head(n = 2) %>% 
  ungroup() %>% 
  add_row(ville = "...") %>% 
  kable()
```


# Visualisation

```{r}
#| label: fig-date-recolte
#| fig-cap: Évolution de la date de récolte potentielle du maïs grain
recolte %>% 
  mutate(doy = yday(date),
         date_virtuelle = as_date(parse_date_time(glue("2020-{str_pad(doy, 3, 'left', '0')}"), 
                                                  orders = "yj"))) %>% 
  ggplot(aes(annee, date_virtuelle, color = ville)) +
  geom_point() +
  geom_smooth(method = lm) +
  scale_y_date(date_breaks = "months", date_labels = "%b") +
  labs(title = "Date de récolte potentielle",
       subtitle = "Maïs grain",
       x = "année",
       y = "jour",
       color = "lieu",
       caption = glue("d'après données agroclimatiques ERA5
                       pour une précocité moyenne ({besoin} DJ, base {base} °C)"))
```

# Tendance

```{r}
#| label: tendance
mod <- recolte %>% 
  mutate(doy = yday(date)) %>% 
  glm(doy ~ annee + ville, data = .)

tbl_regression(mod)
```

```{css}
#| echo: false
code {font-size: .8em}
.toc-section-number:after, .header-section-number:after {content: ". "}
q {quotes:'« ' ' »' '“' '”' '‘' '’'}
```
